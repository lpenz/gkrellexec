---
sudo: required # docker
services:
  - docker
addons:
  apt:
    packages:
      - pkg-config
      - gkrellm
      - libgtk2.0-dev
      - devscripts
      - fakeroot
      - debhelper
      - build-essential
      - txt2tags
jobs:
  include:
    - env: [ ACTION=build ]
      compiler: gcc
    - env: [ ACTION=build ]
      compiler: clang
    - env: [ ACTION=omnilint ]
    - env: [ ACTION=format ]
language: c
script:
  - |
    if [ "$ACTION" = omnilint ]; then
        docker pull lpenz/omnilint
        docker run --rm -v "$PWD:$PWD" -e "RWD=$PWD" -e "MY_UID=$UID" lpenz/omnilint
    elif [ "$ACTION" = format ]; then
        docker build -t image:latest .
        docker run -v $PWD:/home/user/work -e MY_UID=$UID image find . -name '*.[ch]' -o -name '*.cc' -exec clang-format '-style={BasedOnStyle: google, IndentWidth: 4}' -i {} +
        git diff --exit-code
    else
        make
        dpkg-buildpackage -uc -us
    fi
deploy:
  provider: packagecloud
  repository: lpenz
  username: lpenz
  token:
    secure: g26ixB08/ggWL3aMXIjJAGZq0ALhjKcwPiXCTYOFDA8A6MpYALdKrl6Tm7k2NweVU5AYseIzJ/ufF9R/4MTGk8u6V/f8HK7tVy/1wu/+ne1va8E5WJR8ZNuMjzkTnCaik7RnT2Qri06v2TlC4rRJwc6N+iB62R4XvQFA/rq5MtU=
  dist: debian/stretch
  local-dir: '..'
  package_glob: '*.deb'
  on:
    tags: true
    condition: "$CC = gcc && $ACTION = build"
